// Prisma schema for SaaS Multi-Tenant WhatsApp CRM/ERP
// Modelagem: Usuários, Empresas, Instâncias WhatsApp, Produtos, Kanban, Agendamentos, Permissões, Histórico IA

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Tenant {
  id   String @id @default(uuid())
  name String
  slug String @unique

  operationMode   VendorMode @default(SELLER)
  vendorPhone     String?
  enableInvoices  Boolean    @default(false)
  invoiceTemplate String?

  apiKeys               ApiKey[]
  users                 User[]
  whatsapp              WhatsAppInstance[]
  products              Product[]
  kanban                KanbanBoard[]
  schedules             Schedule[]
  contacts              Contact[]
  quickReplies          QuickReply[]
  iaHistories           IAHistory[]
  wordPressIntegrations WordPressIntegration[]
  wordPressProducts     WordPressProduct[]
  orders                Order[]
  whatsappConfig        TenantWhatsAppConfig?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ApiKey {
  id        String     @id @default(uuid())
  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  tenantId  String
  type      ApiKeyType
  key       String
  createdAt DateTime   @default(now())
}

enum ApiKeyType {
  OPENAI
  GEMINI
}

model User {
  id                    String     @id @default(uuid())
  tenant                Tenant     @relation(fields: [tenantId], references: [id])
  tenantId              String
  email                 String
  name                  String
  phone                 String?
  password              String
  role                  UserRole   @default(CUSTOMER)
  status                UserStatus @default(PENDING_ONBOARDING)
  onboardingCompletedAt DateTime?

  preferences  UserPreferences?
  iaHistories  IAHistory[]
  vendorOrders Order[]          @relation("vendor_orders")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, email])
  @@index([tenantId])
}

enum UserRole {
  SUPERADMIN
  ADMIN
  AGENT
  VIEWER
  VENDOR
  ATTENDANT
  CUSTOMER
}

enum UserStatus {
  PENDING_ONBOARDING
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum VendorMode {
  SELLER
  SERVICE
  SUPPORT
}

model WhatsAppInstance {
  id          String    @id @default(uuid())
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  tenantId    String
  name        String
  instanceKey String    @unique
  status      String
  chats       Chat[]
  contacts    Contact[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Chat {
  id            String           @id @default(uuid())
  whatsapp      WhatsAppInstance @relation(fields: [whatsappId], references: [id])
  whatsappId    String
  contact       Contact          @relation(fields: [contactId], references: [id])
  contactId     String
  messages      Message[]
  orders        Order[]
  audioMessages AudioMessage[]
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  iaHistories   IAHistory[]
}

model Contact {
  id         String           @id @default(uuid())
  tenant     Tenant           @relation(fields: [tenantId], references: [id])
  tenantId   String
  whatsapp   WhatsAppInstance @relation(fields: [whatsappId], references: [id])
  whatsappId String

  name          String
  phone         String
  email         String?
  chats         Chat[]
  kanban        KanbanCard[]
  orders        Order[]
  audioMessages AudioMessage[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([tenantId])
  @@index([phone])
}

model Message {
  id        String      @id @default(uuid())
  chat      Chat        @relation(fields: [chatId], references: [id])
  chatId    String
  sender    String
  content   String
  type      MessageType
  createdAt DateTime    @default(now())
}

enum MessageType {
  USER
  BOT
  SYSTEM
}

model Product {
  id        String   @id @default(uuid())
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  tenantId  String
  name      String
  category  String
  price     Float?
  url       String?
  stock     Int?
  metadata  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model KanbanBoard {
  id        String        @id @default(uuid())
  tenant    Tenant        @relation(fields: [tenantId], references: [id])
  tenantId  String
  name      String
  stages    KanbanStage[]
  createdAt DateTime      @default(now())
}

model KanbanStage {
  id      String       @id @default(uuid())
  board   KanbanBoard  @relation(fields: [boardId], references: [id])
  boardId String
  name    String
  order   Int
  cards   KanbanCard[]
}

model KanbanCard {
  id          String      @id @default(uuid())
  stage       KanbanStage @relation(fields: [stageId], references: [id])
  stageId     String
  contact     Contact     @relation(fields: [contactId], references: [id])
  contactId   String
  title       String
  description String?
  order       Int
  createdAt   DateTime    @default(now())
}

model Schedule {
  id        String         @id @default(uuid())
  tenant    Tenant         @relation(fields: [tenantId], references: [id])
  tenantId  String
  name      String
  type      ScheduleType
  target    String
  payload   Json
  runAt     DateTime
  status    ScheduleStatus
  createdAt DateTime       @default(now())
}

enum ScheduleType {
  DRIP
  MASS
}

enum ScheduleStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

model QuickReply {
  id        String   @id @default(uuid())
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  tenantId  String
  label     String
  content   String
  createdAt DateTime @default(now())
}

model IAHistory {
  id        String     @id @default(uuid())
  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  tenantId  String
  user      User?      @relation(fields: [userId], references: [id])
  userId    String?
  chat      Chat?      @relation(fields: [chatId], references: [id])
  chatId    String?
  prompt    String
  response  String
  source    IAProvider
  createdAt DateTime   @default(now())
}

enum IAProvider {
  OPENAI
  GEMINI
  OLLAMA
}

model WordPressIntegration {
  id          String  @id @default(uuid())
  tenant      Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId    String
  siteUrl     String // https://exemplo.com.br
  apiUrl      String // https://exemplo.com.br/wp-json/wp/v2
  username    String? // Para autenticação básica
  appPassword String? // Gerado no WordPress
  isActive    Boolean @default(true)

  // Configuração de campos sincronizados
  syncProducts Boolean @default(true)
  syncPosts    Boolean @default(false)
  syncPages    Boolean @default(false)

  // Campos a sincronizar de produtos
  productFields String @default("id,name,description,price,images,categories,attributes") // JSON array

  lastSyncedAt  DateTime?
  syncFrequency Int       @default(3600) // segundos (1 hora)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, siteUrl])
  @@index([tenantId])
}

model WordPressProduct {
  id              String  @id @default(uuid())
  tenant          Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantId        String
  wpProductId     Int // ID do produto no WordPress
  name            String
  slug            String
  description     String? @db.Text
  longDescription String? @db.Text
  price           Float?
  regularPrice    Float?
  salePrice       Float?
  image           String? // URL da imagem principal
  images          String? @db.Text // JSON array de URLs
  categories      String? // JSON array de categorias
  tags            String? // JSON array de tags
  attributes      Json? // Campos personalizados do WP
  stock           Int?
  status          String? // publish, draft, etc

  // Para busca de contexto na IA
  syncedAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, wpProductId])
  @@index([tenantId])
  @@index([name])
}

// ============= NOVA FASE 1: MODELS DE PEDIDOS, ÁUDIO, PAGAMENTO =============

model UserPreferences {
  id     String @id @default(uuid())
  userId String @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  operationMode VendorMode @default(SELLER)
  audioEnabled  Boolean    @default(true)
  audioLanguage String     @default("pt-BR")
  audioSpeed    Float      @default(1.0)

  language String @default("pt-BR")
  timezone String @default("America/Sao_Paulo")

  notificationEmail    Boolean @default(true)
  notificationSMS      Boolean @default(false)
  notificationsEnabled Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId])
}

enum OrderStatus {
  DRAFT
  CONFIRMED
  PENDING_PAYMENT
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
  REFUNDED
}

model Order {
  id       String @id @default(uuid())
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  chatId String @db.Uuid
  chat   Chat   @relation(fields: [chatId], references: [id])

  contactId String  @db.Uuid
  contact   Contact @relation(fields: [contactId], references: [id])

  vendorId String? @db.Uuid
  vendor   User?   @relation("vendor_orders", fields: [vendorId], references: [id])

  status        OrderStatus   @default(DRAFT)
  paymentStatus PaymentStatus @default(PENDING)
  paymentMethod String?
  paymentProof  PaymentProof?

  sentToVendor      Boolean   @default(false)
  sentToVendorAt    DateTime?
  vendorOrderNumber String?
  invoiceUrl        String?
  invoiceData       Json?

  items OrderItem[]

  subtotal Decimal @default(0)
  tax      Decimal @default(0)
  discount Decimal @default(0)
  total    Decimal @default(0)

  notes String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  confirmedAt DateTime?

  @@index([tenantId, paymentStatus])
  @@index([chatId])
  @@index([vendorId])
}

model OrderItem {
  id      String @id @default(uuid())
  orderId String @db.Uuid
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productSource   String
  productSourceId String?
  productName     String

  unitPrice Decimal
  quantity  Int
  subtotal  Decimal

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
}

model PaymentProof {
  id      String @id @default(uuid())
  orderId String @db.Uuid
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  proofType String
  proofUrl  String
  proofData Json?

  isVerified        Boolean   @default(false)
  verifiedBy        String?
  verifiedAt        DateTime?
  verificationNotes String?

  uploadedAt DateTime @default(now())

  @@unique([orderId])
}

enum AudioStatus {
  RECEIVED
  CONVERTING
  TRANSCRIBED
  TRANSCRIPTION_FAILED
  PROCESSING_ERROR
  PROCESSED
}

model AudioMessage {
  id String @id @default(uuid())

  chatId String @db.Uuid
  chat   Chat   @relation(fields: [chatId], references: [id])

  contactId String  @db.Uuid
  contact   Contact @relation(fields: [contactId], references: [id])

  audioPath String
  mimeType  String
  sizeBytes Int
  duration  Int

  status AudioStatus @default(RECEIVED)

  transcript           String?
  transcriptConfidence Float?
  transcribedAt        DateTime?
  transcriptionTimeMs  Int?

  errorMessage String?

  createdAt DateTime @default(now())

  @@index([chatId])
}

model TTSCache {
  id String @id @default(uuid())

  textHash String
  language String

  audioPath    String
  audioUrl     String
  audioFormat  String?
  duration     Int
  originalText String?
  voice        String?
  hitCount     Int      @default(0)
  createdAt    DateTime @default(now())

  provider    String
  generatedAt DateTime @default(now())
  expiresAt   DateTime

  @@unique([textHash, language])
  @@index([language, expiresAt])
}

model TenantWhatsAppConfig {
  id       String @id @default(uuid())
  tenantId String @db.Uuid
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  vendorPhoneNumber String
  vendorPhoneName   String?
  vendorInstanceKey String?

  autoSendOrder       Boolean @default(true)
  includePaymentProof Boolean @default(true)
  invoiceTemplate     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId])
}
