#!/usr/bin/env python3
import paramiko
import os
import time

host = '46.202.147.151'
user = 'root'
password = '2705#Data2705'

def upload_directory(sftp, local_path, remote_path, ssh=None):
    """Upload directory recursively"""
    count = 0
    for item in os.listdir(local_path):
        if item == 'dist' or item == '.git':  # Skip estas
            continue
        
        local_item = os.path.join(local_path, item)
        remote_item = f"{remote_path}/{item}"
        
        if os.path.isdir(local_item):
            try:
                sftp.stat(remote_item)
            except:
                if ssh:
                    stdin, stdout, stderr = ssh.exec_command(f'mkdir -p {remote_item}')
                    stdout.read()
                else:
                    sftp.mkdir(remote_item)
            upload_directory(sftp, local_item, remote_item, ssh)
        else:
            try:
                sftp.put(local_item, remote_item)
                count += 1
                if count % 50 == 0:
                    print(f"  {count} files synced...")
            except:
                pass
    return count

ssh = paramiko.SSHClient()
ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
print("üîå Conectando...")
ssh.connect(host, username=user, password=password, timeout=30)

print("\nüóëÔ∏è  Removendo node_modules antigos na VPS...")
stdin, stdout, stderr = ssh.exec_command('rm -rf /var/www/botia/apps/backend/node_modules')
stdout.read()

print("\nüì¶ Sincronizando node_modules (isso pode levar alguns minutos)...")

sftp = ssh.open_sftp()

local_dir = r'C:\bot ia\apps\backend\node_modules'
remote_dir = '/var/www/botia/apps/backend/node_modules'

print(f"Local: {local_dir}")
print(f"Remote: {remote_dir}")

# Create base directory
stdin, stdout, stderr = ssh.exec_command(f'mkdir -p {remote_dir}')
stdout.read()

print("\n‚¨ÜÔ∏è  Uploading...")
count = upload_directory(sftp, local_dir, remote_dir, ssh)

print(f"\n‚úÖ {count} files synced!")

sftp.close()
ssh.close()
